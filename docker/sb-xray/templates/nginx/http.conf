server {
    listen                          ${LISTENING_PORT} quic reuseport; #仅版本不小于 v1.25.0 且 SSL 库支持 QUIC（HTTP/3） 配置，否则必须删除。
    listen                          [::]:${LISTENING_PORT} quic reuseport; #仅版本不小于 v1.25.0 且 SSL 库支持 QUIC（HTTP/3） 配置，否则必须删除。另无 IPv6，此项也可删除。
    listen                          unix:/dev/shm/nginx.sock ssl proxy_protocol default_server; #仅版本不小于 v1.25.1 才配置，否则必须删除。

    http2                           on;
    http3                           on;

    server_name                     ${DOMAIN};

    set_real_ip_from                unix:;
    real_ip_header                  proxy_protocol;

    ssl_trusted_certificate          ${SSL_PATH}/${DOMAIN}-ca.crt;
    ssl_certificate                  ${SSL_PATH}/${DOMAIN}.crt;
    ssl_certificate_key              ${SSL_PATH}/${DOMAIN}.key;

    # SSL协议优化
    ssl_protocols                   TLSv1.2 TLSv1.3; #若使用 OpenSSL 库，TLSv1.3 需要 OpenSSL 库的版本不小于 1.1.1 构建才支持。
    ssl_prefer_server_ciphers       on; #优先使用服务端的密码套件。（对如下 TLSv1.2 协议的密码套件有效）
    ssl_ciphers                     ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-CHACHA20-POLY1305; #若证书为 RSA 证书，所有 ECDSA 改为 RSA。
    # ssl_ecdh_curve                  secp521r1:secp384r1:secp256r1:x25519; #若使用 OpenSSL 库，此项配置参数需要 OpenSSL 库的版本不小于 3.0.0 构建才支持。
    ssl_session_timeout             1d;

    # HTTP3响应头
    add_header                      Alt-Svc 'h3=":443"; ma=2592000; h3-29=":443"; ma=2592000'; #通告 HTTP/3 server 的可用性
    add_header                      Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always; #启用 HSTS

    # 安全响应头
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";

    location /${V2RAY_URL_PATH} {
        proxy_pass          http://127.0.0.1:${V2RAY_LOCAL_PORT};
        proxy_redirect      off;
        proxy_http_version  1.1;
        proxy_set_header    X-Real-IP $remote_addr;
        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header    Upgrade $http_upgrade;
        proxy_set_header    Connection "upgrade";
        proxy_set_header    Host $http_host;

        # Config for 0-RTT in TLSv1.3
        proxy_set_header    Early-Data $ssl_early_data;
    }

    location ${DUFS_PATH_PREFIX}/ {
        proxy_pass                  http://127.0.0.1:${DUFS_PORT}${DUFS_PATH_PREFIX}/;
    }

    location /supervisor/ {
        proxy_pass                  http://unix:/var/run/supervisor.sock:/;
        proxy_set_header            X-Real-IP $remote_addr;
        proxy_set_header            X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header            X-Forwarded-Proto $scheme;
        proxy_set_header            Host $host;

        # 防止长连接超时问题
        proxy_read_timeout          300;
        proxy_send_timeout          300;

        # WebSocket 支持，用于日志流
        proxy_http_version          1.1;
        proxy_set_header            Connection "upgrade";

        proxy_redirect              default;
    }

    location /${XUI_WEBBASEPATH}/ {
        proxy_pass                  http://127.0.0.1:${XUI_LOCAL_PORT}/${XUI_WEBBASEPATH}/;
    }

    location /${XRAY_XHTTP_URL_PATH}/ { #与 VLESS+XHTTP 应用中 path 对应
        # 以下参数请根据服务器内存大小自行调整
        grpc_buffer_size         16k;
        grpc_socket_keepalive    on;
        grpc_read_timeout        1h;
        grpc_send_timeout        1h;

        grpc_set_header Connection         "";
        grpc_set_header X-Real-IP          $remote_addr;
        grpc_set_header Forwarded          $proxy_add_forwarded;
        grpc_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
        grpc_set_header X-Forwarded-Proto  $scheme;
        grpc_set_header X-Forwarded-Port   $server_port;
        grpc_set_header Host               $host;
        grpc_set_header X-Forwarded-Host   $host;

        grpc_pass                           unix:/dev/shm/udsxhttp.sock;#转发给本机 VLESS+XHTTP 监听进程
    }

    # 反代 sing-box vless websocket
    location /${SB_UUID}-vless {
        proxy_pass                          http://127.0.0.1:${PORT_VLESS_WS};
        proxy_http_version                  1.1;
        proxy_set_header Upgrade            $http_upgrade;
        proxy_set_header Connection         "upgrade";
        proxy_set_header X-Real-IP          $remote_addr;
        proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
        proxy_set_header Host               $host;
        proxy_redirect                      off;
        # Config for 0-RTT in TLSv1.3
        proxy_set_header Early-Data         $ssl_early_data;
    }
    # 反代 sing-box websocket
    location /${SB_UUID}-vmess {
        proxy_pass                          http://127.0.0.1:${PORT_VMESS_WS};
        proxy_http_version                  1.1;
        proxy_set_header Upgrade            $http_upgrade;
        proxy_set_header Connection         "upgrade";
        proxy_set_header X-Real-IP          $remote_addr;
        proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
        proxy_set_header Host               $host;
        proxy_redirect                      off;
        # Config for 0-RTT in TLSv1.3
        proxy_set_header Early-Data         $ssl_early_data;
    }
    # 来自 /auto 的分流
    location ~ ^/all-sing-box/auto {
        default_type 'text/plain; charset=utf-8';
        alias ${WORKDIR}/subscribe/$path;
    }

    location ~ ^/all-sing-box/(.*) {
        autoindex on;
        proxy_set_header X-Real-IP $proxy_protocol_addr;
        default_type 'text/plain; charset=utf-8';
        alias ${WORKDIR}/subscribe/$1;
    }

    # 根目录设置伪装站
    location / {
        proxy_pass                  https://www.${DEST_HOST};  # cdn回落域名
        proxy_set_header            Host www.${DEST_HOST};  # cdn回落域名
        proxy_set_header            X-Real-IP $remote_addr;
        proxy_set_header            X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header            X-Forwarded-Proto $scheme;
        proxy_set_header            X-Forwarded-Host $host;
    }

    # location / {
    #     add_header          Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always; #启用 HSTS
    #     root                /home/wwwroot/3DCEList;
    #     index index.html    index.htm;
    # }
}

# cdn xhttp 伪装站设置
server {
    listen                      unix:/dev/shm/nginx.sock ssl proxy_protocol backlog=2048 so_keepalive=on;
    listen                      unix:/dev/shm/fallback.trojan.sock proxy_protocol;

    http3                       on;

    server_name                 ${CDNDOMAIN};

    set_real_ip_from            unix:;
    real_ip_header              proxy_protocol;

    ssl_certificate              ${SSL_PATH}/${CDNDOMAIN}.crt;
    ssl_certificate_key          ${SSL_PATH}/${CDNDOMAIN}.key;
    ssl_trusted_certificate      ${SSL_PATH}/${CDNDOMAIN}-ca.crt;

    # 以下参数请根据服务器内存大小自行调整
    keepalive_time               2h;
    keepalive_timeout            600s;
    keepalive_requests           2048;
    client_body_buffer_size      1m;
    client_body_timeout          600s;
    client_header_timeout        300s;
    large_client_header_buffers  8 16k;
    proxy_connect_timeout        30s;
    proxy_read_timeout           2h;
    proxy_send_timeout           2h;
    proxy_buffering              off;
    proxy_request_buffering      off;

    # HTTP3响应头
    add_header                   Alt-Svc 'h3=":443"; ma=2592000; h3-29=":443"; ma=2592000'; #通告 HTTP/3 server 的可用性
    add_header                   Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always; #启用 HSTS

    # 安全响应头
    add_header                   Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header                   X-Frame-Options DENY;
    add_header                   X-Content-Type-Options nosniff;
    add_header                   X-XSS-Protection "1; mode=block";

    location /${V2RAY_URL_PATH} {
        proxy_pass          http://127.0.0.1:${V2RAY_LOCAL_PORT};
        proxy_redirect      off;
        proxy_http_version  1.1;
        proxy_set_header    X-Real-IP $remote_addr;
        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header    Upgrade $http_upgrade;
        proxy_set_header    Connection "upgrade";
        proxy_set_header    Host $http_host;

        # Config for 0-RTT in TLSv1.3
        proxy_set_header    Early-Data $ssl_early_data;
    }

    location /${XRAY_XHTTP_URL_PATH}/ { #与 VLESS+XHTTP 应用中 path 对应
        # 以下参数请根据服务器内存大小自行调整
        grpc_buffer_size         16k;
        grpc_socket_keepalive    on;
        grpc_read_timeout        1h;
        grpc_send_timeout        1h;

        grpc_set_header Connection         "";
        grpc_set_header X-Real-IP          $remote_addr;
        grpc_set_header Forwarded          $proxy_add_forwarded;
        grpc_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
        grpc_set_header X-Forwarded-Proto  $scheme;
        grpc_set_header X-Forwarded-Port   $server_port;
        grpc_set_header Host               $host;
        grpc_set_header X-Forwarded-Host   $host;

        grpc_pass                           unix:/dev/shm/udsxhttp.sock;#转发给本机 VLESS+XHTTP 监听进程
    }

    # 根目录设置伪装站
    location / {
        proxy_pass                  https://www.${DEST_HOST};  # cdn回落域名
        proxy_set_header            Host www.${DEST_HOST};  # cdn回落域名
        proxy_set_header            X-Real-IP $remote_addr;
        proxy_set_header            X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header            X-Forwarded-Proto $scheme;
        proxy_set_header            X-Forwarded-Host $host;
    }

    # location / {
    #     add_header          Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always; #启用 HSTS
    #     root                /home/wwwroot/3DCEList;
    #     index index.html    index.htm;
    # }
}

server {
    listen                          80   default_server;
    listen                          [::]:80;
    server_name                     _;
    return 301                      https://$host$request_uri; #HTTP 自动跳转 HTTPS，让网站看起来更真实。
}
