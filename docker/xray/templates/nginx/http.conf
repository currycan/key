# https://github.com/lxhao61/integrated-examples/blob/main/Xray(M%2BH%2BG%2BB%2BA)%2BNginx/1_nginx.conf
# Web服务器的配置
server {
    listen                          unix:/dev/shm/nginx.sock ssl;
    http2                           on; #仅版本不小于 v1.25.1 配置，否则必须删除。
    server_name                     ${DOMAIN};

    ssl_trusted_certificate         ${SSL_PATH}/${DOMAIN}-ca.crt;
    ssl_certificate                 ${SSL_PATH}/${DOMAIN}.crt;
    ssl_certificate_key             ${SSL_PATH}/${DOMAIN}.key;
    proxy_ssl_server_name                 on;

    proxy_set_header                Host                 ${DOLLAR}host;
    proxy_set_header                X-Forwarded-For      ${DOLLAR}proxy_add_x_forwarded_for;
    proxy_set_header                X-Forwarded-Proto    ${DOLLAR}scheme;
    proxy_set_header                X-Forwarded-Host     ${DOLLAR}host;
    proxy_set_header                X-Real-IP            ${DOLLAR}proxy_protocol_addr;
    proxy_set_header                Forwarded            ${DOLLAR}proxy_add_forwarded;
    proxy_set_header                X-Forwarded-Port     ${DOLLAR}server_port;

    proxy_connect_timeout           60s;
    proxy_send_timeout              60s;
    proxy_read_timeout              60s;

    # 真实 IP 获取
    real_ip_header                  proxy_protocol;
    set_real_ip_from                127.0.0.1/32;

    # 安全响应头
    add_header                      Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always; #启用 HSTS
    add_header                      X-Content-Type-Options "nosniff" always;
    add_header                      X-Frame-Options "SAMEORIGIN" always;
    add_header                      Referrer-Policy "strict-origin-when-cross-origin";

    location ${DUFS_PATH_PREFIX}/ {
        proxy_pass                  http://127.0.0.1:${DUFS_PORT}${DUFS_PATH_PREFIX}/;
    }

    location /${XUI_WEBBASEPATH}/ {
        proxy_pass                  http://127.0.0.1:${XUI_LOCAL_PORT}/${XUI_WEBBASEPATH}/;
    }

    location / {
        proxy_pass                  https://www.${DEST_HOST}; #第一个回落域名
        proxy_set_header            Host www.${DEST_HOST}; #第一个回落域名
        proxy_set_header            X-Real-IP ${DOLLAR}remote_addr;
        proxy_set_header            X-Forwarded-For ${DOLLAR}proxy_add_x_forwarded_for;
        proxy_set_header            X-Forwarded-Proto ${DOLLAR}scheme;
        proxy_set_header            X-Forwarded-Host ${DOLLAR}host;
    }
}

# xhttp 伪装站设置
server {
    listen                      unix:/dev/shm/nginx.sock ssl backlog=2048 so_keepalive=on;
    http2                       on; #仅版本不小于 v1.25.1 配置，否则必须删除。
    server_name                 ${CDNDOMAIN};

    ssl_certificate             ${SSL_PATH}/${CDNDOMAIN}.crt;
    ssl_certificate_key         ${SSL_PATH}/${CDNDOMAIN}.key;
    ssl_trusted_certificate     ${SSL_PATH}/${CDNDOMAIN}-ca.crt;

    error_log  /var/log/nginx/error_xhttp.log error;
    access_log /var/log/nginx/access_xhttp.log http_json buffer=16k flush=5s;

    # 以下参数请根据服务器内存大小自行调整
    http2_max_concurrent_streams 1024;
    http2_body_preread_size      128k;
    keepalive_time               2h;
    keepalive_timeout            600s;
    keepalive_requests           2048;
    client_body_buffer_size      1m;
    client_body_timeout          600s;
    client_header_timeout        300s;
    large_client_header_buffers  8 16k;
    proxy_connect_timeout        30s;
    proxy_read_timeout           2h;
    proxy_send_timeout           2h;
    proxy_buffering              off;
    proxy_request_buffering      off;

    # 根目录设置伪装站
    # location / {
    #     proxy_pass                  https://www.${DEST_HOST};  # cdn回落域名
    #     proxy_set_header            Host www.${DEST_HOST};  # cdn回落域名
    #     proxy_set_header            X-Real-IP ${DOLLAR}remote_addr;
    #     proxy_set_header            X-Forwarded-For ${DOLLAR}proxy_add_x_forwarded_for;
    #     proxy_set_header            X-Forwarded-Proto ${DOLLAR}scheme;
    #     proxy_set_header            X-Forwarded-Host ${DOLLAR}host;
    # }
    location / {
        add_header          Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always; #启用 HSTS
        root                /home/wwwroot/3DCEList;
        index index.html    index.htm;
    }

    location /${XRAY_XHTTP_URL_PATH}/ {
        # 以下参数请根据服务器内存大小自行调整
        grpc_buffer_size         16k;
        grpc_socket_keepalive    on;
        grpc_read_timeout        1h;
        grpc_send_timeout        1h;

        grpc_set_header Connection         "";
        grpc_set_header X-Real-IP          ${DOLLAR}remote_addr;
        grpc_set_header Forwarded          ${DOLLAR}proxy_add_forwarded;
        grpc_set_header X-Forwarded-For    ${DOLLAR}proxy_add_x_forwarded_for;
        grpc_set_header X-Forwarded-Proto  ${DOLLAR}scheme;
        grpc_set_header X-Forwarded-Port   ${DOLLAR}server_port;
        grpc_set_header Host               ${DOLLAR}host;
        grpc_set_header X-Forwarded-Host   ${DOLLAR}host;

        grpc_pass unix:/dev/shm/udsxhttp.sock;
    }
}

server {
    listen          80   default_server;
    server_name     _;
    return 301      https://${DOLLAR}host${DOLLAR}request_uri; #HTTP 自动跳转 HTTPS，让网站看起来更真实。
}
